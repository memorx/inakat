// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// MODELO DE USUARIOS
// =============================================
model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  password          String    // Hasheada con bcrypt
  nombre            String
  apellidoPaterno   String?
  apellidoMaterno   String?
  role              String    @default("user") // "admin", "company", "user"
  isActive          Boolean   @default(true)
  emailVerified     DateTime?
  lastLogin         DateTime?
  
  // Sistema de Créditos (solo para empresas)
  credits           Int       @default(0)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relaciones
  companyRequest    CompanyRequest?
  jobs              Job[]
  applications      Application[]
  creditPurchases   CreditPurchase[]
  
  @@index([email])
  @@index([role])
  @@index([isActive])
}

// =============================================
// SOLICITUDES DE EMPRESAS
// =============================================
model CompanyRequest {
  id                        Int       @id @default(autoincrement())
  
  // Información del representante
  nombre                    String
  apellidoPaterno           String
  apellidoMaterno           String
  
  // Información de la empresa
  nombreEmpresa             String
  correoEmpresa             String
  sitioWeb                  String?
  razonSocial               String
  rfc                       String    @unique
  direccionEmpresa          String
  
  // Documentos
  identificacionUrl         String?
  documentosConstitucionUrl String?
  
  // Estado y tracking
  status                    String    @default("pending") // pending, approved, rejected
  rejectionReason           String?
  
  // Timestamps
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  approvedAt                DateTime?
  
  // Relación con Usuario (se crea cuando se aprueba)
  userId                    Int?      @unique
  user                      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([status])
  @@index([createdAt])
  @@index([rfc])
  @@index([correoEmpresa])
}

// =============================================
// MENSAJES DE CONTACTO
// =============================================
model ContactMessage {
  id        Int      @id @default(autoincrement())
  nombre    String
  email     String
  telefono  String?
  mensaje   String
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([email])
}

// =============================================
// VACANTES/EMPLEOS
// =============================================
model Job {
  id              Int       @id @default(autoincrement())
  title           String
  company         String
  location        String
  salary          String
  jobType         String    // "Tiempo Completo", "Medio Tiempo", "Contrato"
  workMode        String    @default("presential") // "remote", "hybrid", "presential"
  description     String    @db.Text
  requirements    String?   @db.Text
  status          String    @default("active") // "active", "closed", "draft"
  companyRating   Float?    @default(5.0)
  
  // Sistema de Créditos
  creditCost      Int       @default(0) // Cuántos créditos costó publicar
  
  // Campos para calcular costo
  profile         String?   // "Tecnología", "Diseño Gráfico", etc.
  seniority       String?   // "Practicante", "Jr", "Middle", "Sr", "Director"
  
  // Relación con la empresa que publicó
  userId          Int?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Relación con aplicaciones
  applications    Application[]
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  expiresAt       DateTime?
  
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([location])
  @@index([jobType])
  @@index([workMode])
  @@index([profile])
  @@index([seniority])
}

// =============================================
// APLICACIONES A VACANTES
// =============================================
model Application {
  id              Int       @id @default(autoincrement())

  // Relaciones
  jobId           Int
  job             Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  userId          Int?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Información del candidato
  candidateName   String
  candidateEmail  String
  candidatePhone  String?

  // Documentos
  cvUrl           String?
  coverLetter     String?   @db.Text

  // Estado
  status          String    @default("pending") // "pending", "reviewing", "interviewed", "accepted", "rejected"
  notes           String?   @db.Text

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  reviewedAt      DateTime?

  @@index([jobId])
  @@index([userId])
  @@index([status])
  @@index([candidateEmail])
  @@index([createdAt])
}

// =============================================
// MATRIZ DE PRECIOS (Sistema de Créditos)
// =============================================
model PricingMatrix {
  id          Int      @id @default(autoincrement())
  
  // Categorías
  profile     String   // "Tecnología", "Arquitectura", "Diseño Gráfico", etc.
  seniority   String   // "Practicante", "Jr", "Middle", "Sr", "Director"
  workMode    String   // "remote", "hybrid", "presential"
  location    String?  // "Monterrey", "CDMX", "GDL", etc. (opcional)
  
  // Costo en créditos
  credits     Int
  
  // Metadatos
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([profile, seniority, workMode, location])
  @@index([profile])
  @@index([seniority])
  @@index([workMode])
  @@index([location])
  @@index([isActive])
}

// =============================================
// COMPRAS DE CRÉDITOS
// =============================================
model CreditPurchase {
  id              Int      @id @default(autoincrement())
  
  // Relación con empresa
  userId          Int
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Detalles de la compra
  amount          Int      // Cantidad de créditos comprados
  pricePerCredit  Float    // Precio por crédito (en MXN)
  totalPrice      Float    // Precio total pagado
  packageType     String?  // "single", "pack_10", "pack_15", "pack_20"
  
  // Información de pago (Conekta)
  paymentStatus   String   @default("pending") // "pending", "paid", "failed", "refunded"
  paymentId       String?  @unique // ID de Conekta
  paymentMethod   String?  // "card", "oxxo", "spei"
  receiptUrl      String?  // URL del recibo
  
  // Timestamps
  createdAt       DateTime @default(now())
  paidAt          DateTime?
  
  @@index([userId])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([paymentId])
}

// =============================================
// HISTORIAL DE CRÉDITOS (Auditoría)
// =============================================
model CreditTransaction {
  id            Int      @id @default(autoincrement())
  
  // Relación con empresa
  userId        Int
  
  // Tipo de transacción
  type          String   // "purchase", "spend", "refund", "admin_adjustment"
  amount        Int      // Cantidad (positivo = suma, negativo = resta)
  balanceBefore Int      // Balance antes de la transacción
  balanceAfter  Int      // Balance después de la transacción
  
  // Referencias
  jobId         Int?     // Si se gastó en una vacante
  purchaseId    Int?     // Si fue una compra
  
  // Descripción
  description   String?
  
  // Timestamp
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([jobId])
}

// =============================================
// CANDIDATOS (Inyectados por Admin)
// =============================================
model Candidate {
  id              Int       @id @default(autoincrement())
  
  // Datos personales
  nombre          String
  apellidoPaterno String
  apellidoMaterno String?
  email           String    @unique
  telefono        String?
  
  // Filtros demográficos
  sexo            String?   // "M", "F", "Otro"
  fechaNacimiento DateTime?
  
  // Educación
  universidad     String?
  carrera         String?
  nivelEstudios   String?   // "Licenciatura", "Maestría", "Doctorado", "Técnico"
  
  // Experiencia (años totales - se calcula automáticamente)
  añosExperiencia Int       @default(0)
  
  // Especialidad/Perfil
  profile         String?   // "Tecnología", "Diseño Gráfico", etc.
  seniority       String?   // "Practicante", "Jr", "Middle", "Sr", "Director"
  
  // Documentos y links
  cvUrl           String?
  portafolioUrl   String?
  linkedinUrl     String?
  
  // Fuente del candidato
  source          String    @default("manual") // "manual", "linkedin", "occ", "referido"
  
  // Notas del admin
  notas           String?   @db.Text
  
  // Estado
  status          String    @default("available") // "available", "in_process", "hired", "inactive"
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relaciones
  experiences     Experience[]
  
  @@index([email])
  @@index([sexo])
  @@index([universidad])
  @@index([profile])
  @@index([seniority])
  @@index([status])
  @@index([source])
  @@index([añosExperiencia])
  @@index([createdAt])
}

// =============================================
// EXPERIENCIAS LABORALES DE CANDIDATOS
// =============================================
model Experience {
  id            Int       @id @default(autoincrement())
  
  // Relación con candidato
  candidateId   Int
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  // Datos de la experiencia
  empresa       String
  puesto        String
  ubicacion     String?
  
  // Fechas
  fechaInicio   DateTime
  fechaFin      DateTime? // null = trabajo actual
  esActual      Boolean   @default(false)
  
  // Descripción
  descripcion   String?   @db.Text
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([candidateId])
  @@index([empresa])
  @@index([fechaInicio])
}

